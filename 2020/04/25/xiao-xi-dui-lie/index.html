<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="消息队列, Ramona">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>


    <title>消息队列 | Ramona</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpeg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/love flowers.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Ramona</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/love flowers.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Ramona</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">消息队列</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MQ/">
                                <span class="chip bg-color">MQ</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-category">
                                中间件
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-04-25
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    37 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>消息是人与计算机进行信息传递的有效载体，消息从发送者到接收者的典型传递方式有两种：</p>
<ul>
<li><p>即时消息：即消息从一端发出后（消息发送者）立即就可以达到另一端（消息接收者），这种方式的具体实现就是平时最常见的IM聊天消息；</p>
</li>
<li><p>延迟消息：即消息从一端发出后，首先进入消息队列进行临时存储，然后再由消息队列发送给另一端。</p>
</li>
</ul>
<h2 id="一、消息队列的两种消息模式"><a href="#一、消息队列的两种消息模式" class="headerlink" title="一、消息队列的两种消息模式"></a>一、消息队列的两种消息模式</h2><p>Java消息服务（JavaMessage Service，JMS）应用程序接口是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。它使得分布式通信耦合度更低，消息服务更加可靠。在JMS规范中，支持两种消息模型：点对点模式（point to point， queue）和发布/订阅模式（publish/subscribe，topic）。</p>
<h4 id="点对点模式（P2P）"><a href="#点对点模式（P2P）" class="headerlink" title="点对点模式（P2P）"></a>点对点模式（P2P）</h4><p>消息生产者生产消息发送到<code>Queue</code>中，然后消息消费者从<code>Queue</code>中取出并且消费消息。 消息被消费以后，<code>Queue</code>中不再有存储，所以消息只能被一个消费者消费一次。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge70si329pj30qg08s3zj.jpg" alt="点对点模式" style="zoom:50%;">

<h4 id="发布-订阅模式（Pub-Sub）"><a href="#发布-订阅模式（Pub-Sub）" class="headerlink" title="发布/订阅模式（Pub/Sub）"></a>发布/订阅模式（Pub/Sub）</h4><p>消息生产者发布消息到<code>Topic</code>中，多个消费者可以从该<code>Topic</code>中订阅到这条消息并消费。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge70t1sc7oj30q2096wfm.jpg" alt="发布/订阅模式" style="zoom:50%;">

<h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><p>这两种模式主要区别是：点对模式生产者发送到队列的消息只能被一个消费者消费一次，实现了一个可靠的负载均衡。而发布/订阅模式生产者发布消息到主题中，多个消费者可以订阅该消息，可以重复消费。</p>
<h2 id="二、什么是消息队列？"><a href="#二、什么是消息队列？" class="headerlink" title="二、什么是消息队列？"></a>二、什么是消息队列？</h2><p>消息队列（Message Queue），是一种进程间通信或同一进程的不同线程间的通信方式，把数据放到消息队列的叫做生产者，从消息队列里边取数据叫做消费者。通俗的讲就是把要传输的数据放到队列中，需要消费的系统从队列中取需要的数据。</p>
<p>消息队列是分布式系统中重要的组件，主要用来解决应用耦合、异步消息、流量削锋等问题。实现高性能、高可用、可伸缩和最终一致性架构。是大型分布式系统不可缺少的中间件。在生产环境中，使用较多的消息队列有Kafka、ActiveMQ、RabbitMQ、RocketMQ 等。已被广泛用于电商、即时通讯、社交等各种中大型分布式应用系统。</p>
<h2 id="三、为什么要使用消息队列？"><a href="#三、为什么要使用消息队列？" class="headerlink" title="三、为什么要使用消息队列？"></a>三、为什么要使用消息队列？</h2><p>消息队列在实际生产应用中包含的场景主要有：<strong>解耦、异步、削峰、消息通讯、日志</strong>等。</p>
<h3 id="场景1-应用解耦"><a href="#场景1-应用解耦" class="headerlink" title="场景1 应用解耦"></a>场景1 应用解耦</h3><blockquote>
<p>场景说明：一个系统或者一个模块，调用了多个系统或者模块，互相之间的调用很复杂，维护很麻烦。</p>
</blockquote>
<h4 id="不使用MQ之前"><a href="#不使用MQ之前" class="headerlink" title="不使用MQ之前"></a>不使用MQ之前</h4><p>比如我有一个系统A，它会产生一些数据，然后系统B和系统C需要调用系统A的接口来使用这些数据去做相应的操作，过了一段时间，又新增了系统D，系统D也需要调用系统A接口获取数据完成相应的操作，此时系统A就要修改代码，为系统D开放一个接口供其使用，又过了一段时间，系统B不需要调用系统A的接口获取数据了，此时系统A又要继续修改代码，把之前给系统B提供的接口去掉，除此之外，系统A还要考虑系统B、C、D挂了怎么办，系统超时怎么办，要不要重新发送消息等等一系列问题，就这样系统A需要不断进行很多操作，跟其他系统有严重的耦合。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge77zrsuhaj30pe0ge0u0.jpg" alt="解耦前" style="zoom:50%;">

<h4 id="使用MQ以后"><a href="#使用MQ以后" class="headerlink" title="使用MQ以后"></a>使用MQ以后</h4><p>在系统中加入MQ以后，系统A就只负责把需要发送的数据写到MQ中，至于谁需要数据、谁不需要数据，系统A不需要关心。接下来系统B、系统C如果需要系统A的数据进行操作只需要从MQ中去消费；如果又新增一个系统D也需要系统A的数据，它也直接去MQ中消费即可；如果系统B又不需要这个数据了，那它只需要取消对MQ的消费即可；如果其中某一系统挂了或者出现请求超时等问题，都只跟MQ有关，跟系统A没有关系，这样下来，系统A与其他系统都解耦了。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6hqp040nj30p80l0jt6.jpg" alt="解耦后" style="zoom:50%;">

<h4 id="具体场景"><a href="#具体场景" class="headerlink" title="具体场景"></a>具体场景</h4><p>1、用户下单后，订单系统需要通知库存系统。</p>
<p><strong>不使用MQ前：</strong>用户下单以后，如果出现库存系统无法访问，则订单减库存将失败，从而导致订单失败，订单系统与库存系统耦合。</p>
<p><strong>使用MQ后</strong>：对于订单系统，用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功。对于库存系统，订阅下单的消息，采用拉/推的方式，获取下单信息，库存系统根据下单信息，进行库存操作。如果在下单时库存系统不能正常访问。也不会影响正常下单，因为下单后，订单系统写入消息队列就不再关心其他的后续操作了。实现订单系统与库存系统的应用解耦。</p>
<p>2、用户在某一系统上传一张图片，人脸识别系统会对该图片进行人脸识别。</p>
<p><strong>不使用MQ前</strong>：用户上传照片，服务器接收到图片后，图片上传系统立即调用人脸识别系统，需要人脸识别系统处理完成后，再返回给客户端，这样的方式延迟高，如果人脸识别系统被调失败，则导致图片上传失败，即使用户并不需要立即知道结果。因为图片上传系统与人脸识别系统之间的互相调用存在耦合。</p>
<p><strong>使用MQ后</strong>：客户端上传图片后，图片上传系统将图片信息、批次写入消息队列，直接返回成功；而人脸识别系统则定时从消息队列中取数据，完成对新增图片的识别。此时图片上传系统并不需要关心人脸识别系统是否对这些图片信息的处理、以及何时对这些图片信息进行处理。事实上，由于用户并不需要立即知道人脸识别结果，人脸识别系统可以选择不同的调度策略，按照闲时、忙时、正常时间，对队列中的图片信息进行处理。</p>
<h3 id="场景2-异步处理"><a href="#场景2-异步处理" class="headerlink" title="场景2 异步处理"></a>场景2 异步处理</h3><blockquote>
<p>场景说明：用户对某系统发送一个请求，如果系统从接受用户请求操作到响应给用户能够在 200 ms 以内完成，那用户几乎是无感知的，如果请求耗时很长，比如等到将近1s，这几乎不可接受的，用户体验很差。</p>
</blockquote>
<h4 id="不使用MQ之前-1"><a href="#不使用MQ之前-1" class="headerlink" title="不使用MQ之前"></a>不使用MQ之前</h4><p>比如有一个用户，对A系统发送一个请求，A系统接收用户请求后，需要在自己本地写库耗时50ms，同时需要调用系统B、系统C和系统D分别写库，耗时200ms、300ms和300ms，那么通过计算可以知道这次请求总延时需要850ms，耗时很长，对于用户体验是极差的。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6e2ju517j30q00dewfc.jpg" alt="异步前" style="zoom:50%;">

<h4 id="使用MQ以后-1"><a href="#使用MQ以后-1" class="headerlink" title="使用MQ以后"></a>使用MQ以后</h4><p>在系统中加入MQ以后，用户发送请求到系统A，系统A写入本地耗时50ms，然后系统A把消息写入MQ队列中，耗时50ms，然后系统A就直接返回响应给用户，通过将调用其他接口异步化，总延时只需要需要100ms，对于用户来说是几乎是无感知的，提高了用户体验和吞吐量。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6hrbnkinj30r20ki0uq.jpg" alt="异步后" style="zoom:50%;">

<h4 id="具体场景-1"><a href="#具体场景-1" class="headerlink" title="具体场景"></a>具体场景</h4><p>用户注册某一网站后，网站系统需要发送注册邮件和注册短信给用户。</p>
<p><strong>不使用MQ之前</strong>：在串行方式下，用户发送注册请求后，系统需要将注册信息写入数据库成功后，再发送注册邮件，然后发送注册短信，等所有任务执行完成后，返回信息给客户端；在并行方式下，系统将注册信息写入数据库成功后，同时进行发送注册邮件和发送注册短信的操作，等所有任务执行完成后，返回信息给客户端，同串行方式相比，并行方式可以提高执行效率，减少执行时间，但耗时还是比较长的。</p>
<p><strong>使用MQ以后</strong>：用户发送注册请求，系统将注册信息写入数据库成功后，发送注册邮件、注册短信的消息到消息队列，即可返回执行结果，写入消息队列的时间很快，几乎可以忽略，用户的响应时间基本相当于将用户数据写入数据库的时间。</p>
<h3 id="场景3-限流削峰"><a href="#场景3-限流削峰" class="headerlink" title="场景3 限流削峰"></a>场景3 限流削峰</h3><blockquote>
<p>场景说明：在某一段时间内，系统的每秒并发请求突然暴增，比如达到3000个请求，而处理请求的机器最多只能处理2000个请求，此时将会导致系统崩溃。</p>
</blockquote>
<h4 id="不使用MQ之前-2"><a href="#不使用MQ之前-2" class="headerlink" title="不使用MQ之前"></a>不使用MQ之前</h4><p>比如有一系统A是电商平台，在往常用户并发请求数量只有1000个，但是一到促销活动的时候，并发请求数量就会暴增，比如每秒发送3000个请求，但是该用于处理请求的机器最多能处理2000个请求，这就会导致系统崩溃，但是促销活动一结束，就到了低峰期，每秒的并发请求也就只有1000个，对于系统没有压力。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6g0xl2ocj30ma07ut98.jpg" alt="削峰前" style="zoom:50%;">

<h4 id="使用MQ以后-2"><a href="#使用MQ以后-2" class="headerlink" title="使用MQ以后"></a>使用MQ以后</h4><p>在系统加入MQ以后，服务器在接收到大量的用户请求后，先把并发请求写入到MQ，处理请求的机器就会根据自己每秒能处理的最大请求数从MQ中拉取请求，通过这样的方式，即使在高峰期，系统就不会崩溃，这样虽然会将过多的请求积压到MQ中，但是高峰期过后，并发请求数量就会下降，处理请求的机器很快可以把积压在MQ中的请求解决掉。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge70pn1nddj30xg07cwfb.jpg" alt="削峰后" style="zoom:50%;">

<h4 id="具体场景-2"><a href="#具体场景-2" class="headerlink" title="具体场景"></a>具体场景</h4><p>在某一段时间秒杀或团抢活动中，大量用户购买商品。</p>
<p><strong>不使用MQ之前</strong>：在某一段时间秒杀活动开始，大量的用户参与抢购，并发请求数量过多，导致系统挂掉。</p>
<p><strong>使用MQ以后</strong>：在某一段时间秒杀活动开始后，用户并发请求暴增，服务器接收到用户请求后，先将其写入消息队列，处理请求的机器根据能处理的最大请求数从消息队列中拉取请求，进行后续处理，可以缓解系统压力，避免系统崩溃。</p>
<h3 id="场景4-日志处理"><a href="#场景4-日志处理" class="headerlink" title="场景4 日志处理"></a>场景4 日志处理</h3><p>日志处理是指将消息队列用在日志处理中，比如Linkedin这种大型职业社交应用架构中Kafka的应用（Kafka就是Linkedin开发并开源的），解决大量日志传输的问题。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6iiosecgj30u0052t96.jpg" alt="日志处理" style="zoom:50%;">

<ul>
<li>日志采集客户端：负责日志数据采集，定时写受写入Kafka队列；</li>
<li>Kafka消息队列：负责日志数据的接收，存储和转发；</li>
<li>日志处理应用：订阅并消费kafka队列中的日志数据；</li>
</ul>
<h3 id="场景5-消息通讯"><a href="#场景5-消息通讯" class="headerlink" title="场景5 消息通讯"></a>场景5 消息通讯</h3><p>消息通讯是指，消息队列一般都内置了高效的通信机制，因此也可以用在线的消息通讯。比如实现点对点消息队列、聊天室等。</p>
<h4 id="点对点通讯"><a href="#点对点通讯" class="headerlink" title="点对点通讯"></a>点对点通讯</h4><p>在点对点通讯架构设计中，客户端A和客户端B共用一个消息队列，即可实现消息通讯功能。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6i04mhi8j30sc0683yx.jpg" alt="点对点通讯" style="zoom:50%;">

<h4 id="聊天室通讯"><a href="#聊天室通讯" class="headerlink" title="聊天室通讯"></a>聊天室通讯</h4><p>客户端A、客户端B、客户端C直至客户端N订阅同一消息队列，进行消息的发布与接收。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge6i9pqssuj30rg0awmy1.jpg" alt="聊天室通讯" style="zoom:50%;">

<h2 id="四、使用消息队列会存在什么问题？"><a href="#四、使用消息队列会存在什么问题？" class="headerlink" title="四、使用消息队列会存在什么问题？"></a>四、使用消息队列会存在什么问题？</h2><p>通过上诉介绍，我们知道，在特定场景下，使用消息队列会带来很多好处，但是有优点必然也会存在缺点，接下来就介绍一下使用消息队列以后会存在的一些问题。</p>
<h4 id="系统可用性降低"><a href="#系统可用性降低" class="headerlink" title="系统可用性降低"></a>系统可用性降低</h4><p>当我们在系统中加入MQ以后，导致系统引入的外部依赖增加，系统可用性降低，越容易出现问题，如果我们使用单机的消息队列，如果MQ挂掉以后，那我们的整个系统就崩掉了，不能用了，因此我们就需要考虑MQ的高可用问题。</p>
<h4 id="系统复杂度提高"><a href="#系统复杂度提高" class="headerlink" title="系统复杂度提高"></a>系统复杂度提高</h4><p>当我们在系统中加入MQ以后，导致系统需要考虑的问题增多，比如由于系统A与MQ协调问题，系统A可能会把同一条消息发送给系统B两次，这就需要考虑消息被重复消费问题；或者系统A像MQ中发送了一条消息，而MQ把消息丢失了，其他系统去MQ中消费消息时找不到，这就需要考虑消息丢失问题；或者系统A向MQ中连续发送了3条消息，它们是有顺序的，而到了MQ以后消息顺序乱了，导致其他系统拿到的数据顺序也是乱的，这就需要考虑消息队列的顺序性问题；或者系统A在MQ中不断发送消息，而其他系统挂掉了，导致大量的消息在MQ中积压，这也是需要我们考虑的问题。因此MQ会导致系统的复杂性提高。</p>
<h4 id="系统一致性问题"><a href="#系统一致性问题" class="headerlink" title="系统一致性问题"></a>系统一致性问题</h4><p>假如用户发送请求给系统A，系统A处理请求并把请求写入MQ，系统B、C需要到MQ中消费，等所有的系统都执行完成后才能返回，然而，在此过程中会出现系统A、B执行成功返回，而系统C执行失败，这就会导致数据不一致，这就需要我们考虑一致性问题。</p>
<h2 id="五、如何解决消息队列存在的问题？"><a href="#五、如何解决消息队列存在的问题？" class="headerlink" title="五、如何解决消息队列存在的问题？"></a>五、如何解决消息队列存在的问题？</h2><p>通过上诉分析，我们可以发现，使用消息队列以后也会存在很多问题，接下来就出现的问题给出解决方案。</p>
<h3 id="如何保证消息队列的高可用？"><a href="#如何保证消息队列的高可用？" class="headerlink" title="如何保证消息队列的高可用？"></a>如何保证消息队列的高可用？</h3><h4 id="1、RabbitMQ-的高可用性"><a href="#1、RabbitMQ-的高可用性" class="headerlink" title="1、RabbitMQ 的高可用性"></a>1、RabbitMQ 的高可用性</h4><p>RabbitMQ 是比较有代表性的，因为是<strong>基于主从</strong>（非分布式）做高可用性的。RabbitMQ 有三种模式：单机模式、普通集群模式、镜像集群模式。</p>
<h5 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h5><p>本地启动使用单机模式，不适合实际生产环境中。</p>
<h5 id="普通集群模式（无高可用性）"><a href="#普通集群模式（无高可用性）" class="headerlink" title="普通集群模式（无高可用性）"></a>普通集群模式（无高可用性）</h5><p>在多台机器上启动多个 RabbitMQ 实例，每个机器启动一个。你<strong>创建的 queue，只会放在一个 RabbitMQ 实例上</strong>，但是每个实例都同步 queue 的元数据（元数据可以认为是 queue 的一些配置信息，通过元数据，可以找到 queue 所在实例）。消费者消费的时候，实际上如果连接到了另外一个实例，那么那个实例会从 queue 所在实例上拉取数据过来。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge76fj44arj30wq0iatav.jpg" alt="普通集群模式" style="zoom:50%;">

<p>这种集群模式没做到所谓的分布式，就是个普通集群。没有什么所谓的高可用性，主要是<strong>提高吞吐量</strong>的，让集群中多个节点来服务某个 queue 的读写操作。</p>
<p>这种方式有两种情况：一是消费者每次随机连接一个实例然后拉取数据，增加数据拉取的开销，MQ集群内部会产生大量的数据传输；二是固定连接那个 queue 所在实例消费数据，导致单实例性能瓶颈，如果 queue 所在节点宕机了，会导致接下来其他实例就无法从那个实例拉取，数据丢失，如果你<strong>开启了消息持久化</strong>，让 RabbitMQ 落地存储消息的话，<strong>消息不一定会丢</strong>，得等这个实例恢复了，然后才可以继续从这个 queue 拉取数据。</p>
<h5 id="镜像集群模式（高可用性）"><a href="#镜像集群模式（高可用性）" class="headerlink" title="镜像集群模式（高可用性）"></a>镜像集群模式（高可用性）</h5><p>在镜像集群模式下，创建的 queue，无论元数据还是 queue 里的实际消息数据都会<strong>存在于多个实例上</strong>，就是说，每个 RabbitMQ 节点都有这个 queue 的一个<strong>完整镜像</strong>，包含 queue 的全部数据。然后每次写消息到 queue 的时候，都会自动把<strong>消息同步</strong>到多个实例的 queue 上。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge76endurzj30x40j0ac2.jpg" alt="镜像集群模式" style="zoom:50%;">

<p>通过这样的集群方式，当任何一个机器宕机了，其它机器（节点）还包含了这个 queue 的完整数据，别的消费者都可以到其它节点上去消费数据。</p>
<p><strong>缺点</strong>：第一，性能开销太大，消息需要同步到所有机器上，导致网络带宽压力和消耗很重。第二，不是分布式的，就<strong>没有扩展性可言</strong>了，如果某个 queue 负载很重，你加机器，新增的机器也包含了这个 queue 的所有数据，并<strong>没有办法线性扩展</strong>你的 queue。如果这个 queue 的数据量很大，大到这个机器上的容量无法容纳了，此时该怎么办呢？</p>
<h4 id="Kafka-的高可用性"><a href="#Kafka-的高可用性" class="headerlink" title="Kafka 的高可用性"></a>Kafka 的高可用性</h4><p><strong>基本概念</strong>：Kafka由多个 broker 组成，每个 broker 是一个节点；创建一个 topic，这个 topic 可以划分为多个 partition，每个 partition 可以存在于不同的 broker 上，每个 partition 就放一部分数据。</p>
<p>这就是<strong>天然的分布式消息队列</strong>，就是说一个 topic 的数据，是<strong>分散放在多个机器上的，每个机器就放一部分数据</strong>。</p>
<p>实际上 RabbmitMQ 之类的，并不是分布式消息队列，它就是传统的消息队列，只不过提供了一些集群、HA(High Availability, 高可用性) 的机制而已，RabbitMQ 一个 queue 的数据都是放在一个节点里的，镜像集群下，也是每个节点都放这个 queue 的完整数据。</p>
<p><strong>Kafka 0.8 以前，</strong>是没有 HA 机制的，就是任何一个 broker 宕机了，那个 broker 上的 partition 就废了，没法写也没法读，没有什么高可用性可言。比如说，我们假设创建了一个 topic，指定其 partition 数量是 3 个，分别在三台机器上。但是，如果第二台机器宕机了，会导致这个 topic 的 1/3 的数据就丢了，因此这个是做不到高可用的。</p>
<p><strong>Kafka 0.8 以后，</strong>提供了 HA 机制，就是 replica（复制品） 副本机制。每个 partition 的数据都会同步到其它机器上，形成自己的多个 replica 副本。所有 replica 会选举一个 leader 出来，那么生产和消费都跟这个 leader 打交道，然后其他 replica 就是 follower。写的时候，leader 会负责把数据同步到所有 follower 上去，读的时候就直接读 leader 上的数据即可。为什么只能读写 leader呢，<strong>要是你可以随意读写每个 follower，那么就要关心数据一致性的问题</strong>，系统复杂度太高，很容易出问题。Kafka 会均匀地将一个 partition 的所有 replica 分布在不同的机器上，这样才可以提高容错性。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge77uldrbzj31140r076o.jpg" alt="kafka集群高可用" style="zoom:50%;">

<p>这就是所谓的<strong>高可用性</strong>，因为如果某个 broker 宕机了，那个 broker上面的 partition 在其他机器上都有副本的。如果这个宕机的 broker 上面有某个 partition 的 leader，那么此时会从 follower 中<strong>重新选举</strong>一个新的 leader 出来，然后消费者继续读写那个新的 leader 即可。</p>
<p><strong>写数据</strong>的时候，生产者就写入 leader，然后 leader 将数据落地写本地磁盘，接着其他 follower 自己主动从 leader 来 pull 数据。一旦所有 follower 同步好数据了，就会发送 ack 给 leader，leader 收到所有 follower 的 ack 之后，就会返回写成功的消息给生产者。（当然，这只是其中一种模式，还可以适当调整这个行为）</p>
<p><strong>消费</strong>的时候，只会从 leader 去读，但是只有当一个消息已经被所有 follower 都同步成功返回 ack 的时候，这个消息才会被消费者读到。</p>
<h3 id="如何保证消息消费的幂等性（处理重复数据）？"><a href="#如何保证消息消费的幂等性（处理重复数据）？" class="headerlink" title="如何保证消息消费的幂等性（处理重复数据）？"></a>如何保证消息消费的幂等性（处理重复数据）？</h3><p>在开发生产环境中，消息队列都有可能会出现消费重复消费的问题，这问题通常不是MQ自己保证的，是开发保证的。现在主要说明一下kafka是怎么重复消费的并且怎么保证消息的幂等性。</p>
<p>Kafka 实际上有个 offset 的概念，就是每个消息写进去，都有一个 offset，代表消息的序号，然后 consumer 消费了数据之后，<strong>每隔一段时间</strong>（定时定期），会把自己消费过的消息的 offset 提交一下，表示“我已经消费过了，下次我要是重启啥的，你就让我继续从上次消费到的 offset 来继续消费吧”。但是凡事总有意外，在实际生产环境中，如果碰到着急事情需要重启系统，直接 kill 进程了，再重启。这会导致 consumer 有些消息处理了，但是没来得及提交 offset。重启之后，少数消息会再次消费一次。这就会出现重复消费问题。</p>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>假如数据 1、2、3 依次进入 kafka，kafka 会给这三条数据每条分配一个 offset，代表这条数据的序号，我们就假设分配的 offset 依次是 152、153、154。消费者从 kafka 去消费的时候，也是按照这个顺序去消费。假如当消费者消费了 <code>offset=153</code> 的这条数据，刚准备去提交 offset 到 zookeeper，此时消费者进程被重启了。那么此时消费过的数据 1、2 的 offset 并没有提交，kafka 也就不知道你已经消费了 <code>offset=153</code> 这条数据。那么重启之后，消费者会找 kafka 说，嘿，哥儿们，你给我接着把上次我消费到的那个地方后面的数据继续给我传递过来。由于之前的 offset 没有提交成功，那么数据 1、2 会再次传过来，如果此时消费者没有去重的话，那么就会导致重复消费。如果消费者的任务是拿一条数据就往数据库里写一条，会导致你可能就把数据 1、2 在数据库里插入了 2 次，那么数据就错啦。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge862z801kj30n40lcwgv.jpg" alt="消息重复" style="zoom:50%;">

<h4 id="那怎么保证幂等性呢？"><a href="#那怎么保证幂等性呢？" class="headerlink" title="那怎么保证幂等性呢？"></a>那怎么保证幂等性呢？</h4><p>举个例子吧。假设你有个系统，消费一条消息就往数据库里插入一条数据，要是你一个消息重复两次，你就插入了两条，这数据不就错了？但是你要是消费到第二次的时候，自己判断一下是否已经消费过了，若是就直接扔了，这样不就保留了一条数据，从而保证了数据的正确性。一条数据重复出现两次，数据库里就只有一条数据，这就保证了系统的幂等性。</p>
<p>幂等性，通俗点说，就一个数据，或者一个请求，给你重复来多次，你得确保对应的数据是不会改变的，<strong>不能出错</strong>。</p>
<img src="https://i0.wp.com/tva1.sinaimg.cn/large/007S8ZIlly1ge86caxq93j30cm0h8wff.jpg" alt="幂等性" style="zoom:50%;">

<p>保证消息队列消费的幂等性还是得结合业务来思考，这里给几个思路：</p>
<ul>
<li>比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下。</li>
<li>比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。</li>
<li>比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如去 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。</li>
<li>比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。</li>
</ul>
<h3 id="如何保证消息的可靠性传输（处理消息丢失）？"><a href="#如何保证消息的可靠性传输（处理消息丢失）？" class="headerlink" title="如何保证消息的可靠性传输（处理消息丢失）？"></a>如何保证消息的可靠性传输（处理消息丢失）？</h3><p>数据的丢失问题，可能出现在生产者、MQ、消费者中，接下来从从 RabbitMQ 和 Kafka 分别来分析一下。</p>
<h4 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h4><h5 id="生产者弄丢了数据"><a href="#生产者弄丢了数据" class="headerlink" title="生产者弄丢了数据"></a>生产者弄丢了数据</h5><p><strong>场景</strong>：生产者将数据发送到 RabbitMQ 的时候，可能数据就在半路给搞丢了，因为网络问题等情况都有可能发生。</p>
<p><strong>解决方案</strong>1：此时可以选择用 RabbitMQ 提供的事务功能，就是生产者<strong>发送数据之前</strong>开启 RabbitMQ 事务<code>channel.txSelect</code>，然后发送消息，如果消息没有成功被 RabbitMQ 接收到，那么生产者会收到异常报错，此时就可以回滚事务<code>channel.txRollback</code>，然后重试发送消息；如果收到了消息，那么可以提交事务<code>channel.txCommit</code>。但是问题是，RabbitMQ 事务机制（同步）一搞，基本上<strong>吞吐量会下来，因为太耗性能</strong>。</p>
<p><strong>解决方案2</strong>：所以一般来说，如果你要确保说写 RabbitMQ 的消息别丢，可以开启 <code>confirm</code> 模式，在生产者那里设置开启 <code>confirm</code> 模式之后，你每次写的消息都会分配一个唯一的 id，然后如果写入了 RabbitMQ 中，RabbitMQ 会给你回传一个 <code>ack</code> 消息，告诉你说这个消息 ok 了。如果 RabbitMQ 没能处理这个消息，会回调你的一个 <code>nack</code> 接口，告诉你这个消息接收失败，你可以重试。而且你可以结合这个机制自己在内存里维护每个消息 id 的状态，如果超过一定时间还没接收到这个消息的回调，那么你可以重发。</p>
<p><strong>区别</strong>：事务机制和 <code>confirm</code> 机制最大的不同在于，<strong>事务机制是同步的</strong>，你提交一个事务之后会<strong>阻塞</strong>在那儿，但是 <code>confirm</code> 机制是<strong>异步</strong>的，你发送个消息之后就可以发送下一个消息，然后那个消息 RabbitMQ 接收了之后会异步回调你的一个接口通知你这个消息接收到了。所以一般在生产者这块<strong>避免数据丢失</strong>，都是用 <code>confirm</code> 机制的。</p>
<h5 id="RabbitMQ-弄丢了数据"><a href="#RabbitMQ-弄丢了数据" class="headerlink" title="RabbitMQ 弄丢了数据"></a>RabbitMQ 弄丢了数据</h5><p>就是 RabbitMQ 自己弄丢了数据，你必须<strong>开启 RabbitMQ 的持久化</strong>，就是消息写入之后会持久化到磁盘，哪怕是 RabbitMQ 自己挂了，<strong>恢复之后会自动读取之前存储的数据</strong>，一般数据不会丢。除非极其罕见的是，RabbitMQ 还没持久化，自己就挂了，<strong>可能导致少量数据丢失</strong>，但是这个概率较小。</p>
<p>设置持久化有<strong>两个步骤</strong>：</p>
<ul>
<li>创建 queue 的时候将其设置为持久化，这样就可以保证 RabbitMQ 持久化 queue 的元数据，但是它是不会持久化 queue 里的数据的。</li>
<li>第二个是发送消息的时候将消息的 <code>deliveryMode</code> 设置为 2，就是将消息设置为持久化的，此时 RabbitMQ 就会将消息持久化到磁盘上去。</li>
</ul>
<p>必须要同时设置这两个持久化才行，RabbitMQ 哪怕是挂了，再次重启，也会从磁盘上重启恢复 queue，恢复这个 queue 里的数据。</p>
<p>注意，哪怕是你给 RabbitMQ 开启了持久化机制，也有一种可能，就是这个消息写到了 RabbitMQ 中，但是还没来得及持久化到磁盘上，结果不巧，此时 RabbitMQ 挂了，就会导致内存里的一点点数据丢失。</p>
<p>所以，持久化可以跟生产者那边的 <code>confirm</code> 机制配合起来，只有消息被持久化到磁盘之后，才会通知生产者 <code>ack</code> 了，所以哪怕是在持久化到磁盘之前，RabbitMQ 挂了，数据丢了，生产者收不到 <code>ack</code>，你也是可以自己重发的。</p>
<h5 id="消费端弄丢了数据"><a href="#消费端弄丢了数据" class="headerlink" title="消费端弄丢了数据"></a>消费端弄丢了数据</h5><p>RabbitMQ 如果丢失了数据，主要是因为你消费的时候，<strong>刚消费到，还没处理，结果进程挂了</strong>，比如重启了，那么就尴尬了，RabbitMQ 认为你都消费了，这数据就丢了。</p>
<p>这个时候得用 RabbitMQ 提供的 <code>ack</code> 机制，简单来说，就是你必须关闭 RabbitMQ 的自动 <code>ack</code>，可以通过一个 api 来调用就行，然后每次你自己代码里确保处理完的时候，再在程序里 <code>ack</code> 一把。这样的话，如果你还没处理完，不就没有 <code>ack</code> 了？那 RabbitMQ 就认为你还没处理完，这个时候 RabbitMQ 会把这个消费分配给别的 consumer 去处理，消息是不会丢的。</p>
<h2 id="六、常用的消息队列及比较"><a href="#六、常用的消息队列及比较" class="headerlink" title="六、常用的消息队列及比较"></a>六、常用的消息队列及比较</h2><p>本部分主要介绍几种常用的消息队列，包括<code>ActiveMQ</code>、<code>RabbitMQ</code>、<code>RocketMQ</code>、<code>Kafka</code>。</p>
<h3 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h3><p><a href="http://activemq.apache.org/" target="_blank" rel="noopener">ActiveMQ</a>是由Apache出品的一款开源消息中间件，旨在为应用程序提供高效、可扩展、稳定、安全的企业级消息通信。ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现。它非常快速，支持多种语言的客户端和协议，而且可以非常容易的嵌入到企业的应用环境中，并有许多高级功能。</p>
<h4 id="主要特性"><a href="#主要特性" class="headerlink" title="主要特性"></a>主要特性</h4><ol>
<li>服从 JMS 规范：JMS 规范提供了良好的标准和保证，包括：同步或异步的消息分发，一次和仅一次的消息分发，消息接收和订阅等等。遵从 JMS 规范的好处在于，不论使用什么 JMS 实现提供者，这些基础特性都是可用的；</li>
<li>连接性：ActiveMQ 提供了广泛的连接选项，支持的协议有：HTTP/S，IP 多播，SSL，STOMP，TCP，UDP，XMPP等等。对众多协议的支持让 ActiveMQ 拥有了很好的灵活性。</li>
<li>支持的协议种类多：OpenWire、STOMP、REST、XMPP、AMQP ；</li>
<li>持久化插件和安全插件：ActiveMQ 提供了多种持久化选择。而且，ActiveMQ 的安全性也可以完全依据用户需求进行自定义鉴权和授权；</li>
<li>支持的客户端语言种类多：除了 Java 之外，还有：C/C++，.NET，Perl，PHP，Python，Ruby；</li>
<li>代理集群：多个 ActiveMQ 代理可以组成一个集群来提供服务；</li>
<li>异常简单的管理：ActiveMQ 是以开发者思维被设计的。所以，它并不需要专门的管理员，因为它提供了简单又使用的管理特性。有很多中方法可以监控 ActiveMQ 不同层面的数据，包括使用在 JConsole 或者 ActiveMQ 的Web Console 中使用 JMX，通过处理 JMX 的告警消息，通过使用命令行脚本，甚至可以通过监控各种类型的日志。</li>
</ol>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ol>
<li>跨平台(JAVA编写与平台无关有，ActiveMQ几乎可以运行在任何的JVM上)</li>
<li>可以用JDBC：可以将数据持久化到数据库。虽然使用JDBC会降低ActiveMQ的性能，但是数据库一直都是开发人员最熟悉的存储介质。将消息存到数据库，看得见摸得着。而且公司有专门的DBA去对数据库进行调优，主从分离；</li>
<li>支持JMS ：支持JMS的统一接口;</li>
<li>支持自动重连；</li>
<li>有安全机制：支持基于shiro，jaas等多种安全配置机制，可以对Queue/Topic进行认证和授权。</li>
<li>监控完善：拥有完善的监控，包括Web Console，JMX，Shell命令行，Jolokia的REST API；</li>
<li>界面友善：提供的Web Console可以满足大部分情况，还有很多第三方的组件可以使用，如hawtio；</li>
</ol>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>社区活跃度不及RabbitMQ高；</li>
<li>根据其他用户反馈，会出莫名其妙的问题，会丢失消息；</li>
<li>目前重心放到activemq6.0产品-apollo，对5.x的维护较少；</li>
<li>不适合用于上千个队列的应用场景；</li>
</ol>
<h3 id="RabbitMQ-1"><a href="#RabbitMQ-1" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><p><a href="https://www.rabbitmq.com/" target="_blank" rel="noopener">RabbitMQ</a> 2007年发布，是一个在<a href="http://www.amqp.org/" target="_blank" rel="noopener">AMQP</a>(高级消息队列协议)基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。</p>
<h4 id="主要特性-1"><a href="#主要特性-1" class="headerlink" title="主要特性"></a>主要特性</h4><ol>
<li>可靠性: 提供了多种技术可以让你在性能和可靠性之间进行权衡。这些技术包括持久性机制、投递确认、发布者证实和高可用性机制；</li>
<li>灵活的路由： 消息在到达队列前是通过交换机进行路由的。RabbitMQ为典型的路由逻辑提供了多种内置交换机类型。如果你有更复杂的路由需求，可以将这些交换机组合起来使用，你甚至可以实现自己的交换机类型，并且当做RabbitMQ的插件来使用；</li>
<li>消息集群：在相同局域网中的多个RabbitMQ服务器可以聚合在一起，作为一个独立的逻辑代理来使用；</li>
<li>队列高可用：队列可以在集群中的机器上进行镜像，以确保在硬件问题下还保证消息安全；</li>
<li>多种协议的支持：支持多种消息队列协议；</li>
<li>服务器端用Erlang语言编写，支持只要是你能想到的所有编程语言；</li>
<li>管理界面: RabbitMQ有一个易用的用户界面，使得用户可以监控和管理消息Broker的许多方面；</li>
<li>跟踪机制：如果消息异常，RabbitMQ提供消息跟踪机制，使用者可以找出发生了什么；</li>
<li>插件机制：提供了许多插件，来从多方面进行扩展，也可以编写自己的插件；</li>
</ol>
<h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ol>
<li>由于erlang语言的特性，mq 性能较好，高并发；</li>
<li>健壮、稳定、易用、跨平台、支持多种语言、文档齐全；</li>
<li>有消息确认机制和持久化机制，可靠性高；</li>
<li>高度可定制的路由；</li>
<li>管理界面较丰富，在互联网公司也有较大规模的应用；</li>
<li>社区活跃度高；</li>
</ol>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>尽管结合erlang语言本身的并发优势，性能较好，但是不利于做二次开发和维护；</li>
<li>实现了代理架构，意味着消息在发送到客户端之前可以在中央节点上排队。此特性使得RabbitMQ易于使用和部署，但是使得其运行速度较慢，因为中央节点增加了延迟，消息封装后也比较大；</li>
<li>需要学习比较复杂的接口和协议，学习和维护成本较高；</li>
</ol>
<h3 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h3><p><a href="https://github.com/alibaba/RocketMQ" target="_blank" rel="noopener">RocketMQ</a>出自 阿里公司的开源产品，用 Java 语言实现，在设计时参考了 Kafka，并做出了自己的一些改进，消息可靠性上比 Kafka 更好。RocketMQ在阿里集团被广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog分发等场景。</p>
<h4 id="主要特性-2"><a href="#主要特性-2" class="headerlink" title="主要特性"></a>主要特性</h4><ol>
<li>是一个队列模型的消息中间件，具有高性能、高可靠、高实时、分布式特点；</li>
<li>Producer、Consumer、队列都可以分布式；</li>
<li>Producer向一些队列轮流发送消息，队列集合称为Topic，Consumer如果做广播消费，则一个consumer实例消费这个Topic对应的所有队列，如果做集群消费，则多个Consumer实例平均消费这个topic对应的队列集合；</li>
<li>能够保证严格的消息顺序；</li>
<li>提供丰富的消息拉取模式；</li>
<li>高效的订阅者水平扩展能力；</li>
<li>实时的消息订阅机制；</li>
<li>亿级消息堆积能力；</li>
<li>较少的依赖；</li>
</ol>
<h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ol>
<li><p>单机支持 1 万以上持久化队列</p>
</li>
<li><p>RocketMQ 的所有消息都是持久化的，先写入系统 PAGECACHE，然后刷盘，可以保证内存与磁盘都有一份数据， 访问时，直接从内存读取。</p>
</li>
<li><p>模型简单，接口易用（JMS 的接口很多场合并不太实用）；</p>
</li>
<li><p>性能非常好，可以大量堆积消息在broker中；</p>
</li>
<li><p>支持多种消费，包括集群消费、广播消费等。</p>
</li>
<li><p>各个环节分布式扩展设计，主从HA；</p>
</li>
<li><p>开发度较活跃，版本更新很快。</p>
</li>
</ol>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><p>支持的客户端语言不多，目前是java及c++，其中c++不成熟；</p>
<p>RocketMQ社区关注度及成熟度也不及前两者；</p>
<p>没有web管理界面，提供了一个CLI(命令行界面)管理工具带来查询、管理和诊断各种问题；</p>
<p>没有在 mq 核心中去实现JMS等接口；</p>
<h3 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h3><p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">Apache Kafka</a>是一个分布式消息发布订阅系统。它最初由LinkedIn公司基于独特的设计实现为一个分布式的提交日志系统( a distributed commit log)，之后成为Apache项目的一部分。Kafka系统快速、可扩展并且可持久化。它的分区特性，可复制和可容错都是其不错的特性。</p>
<h4 id="主要特性-3"><a href="#主要特性-3" class="headerlink" title="主要特性"></a>主要特性</h4><ol>
<li>快速持久化，可以在O(1)的系统开销下进行消息持久化；</li>
<li>高吞吐，在一台普通的服务器上既可以达到10W/s的吞吐速率； </li>
<li>.完全的分布式系统，Broker、Producer、Consumer都原生自动支持分布式，自动实现<a href="https://cloud.tencent.com/product/clb?from=10680" target="_blank" rel="noopener">负载均衡</a>；</li>
<li>支持同步和异步复制两种HA；</li>
<li>支持数据批量发送和拉取；</li>
<li>zero-copy：减少IO操作步骤；</li>
<li>数据迁移、扩容对用户透明；</li>
<li>无需停机即可扩展机器；</li>
<li>其他特性：严格的消息顺序、丰富的消息拉取模型、高效订阅者水平扩展、实时的消息订阅、亿级的消息堆积能力、定期删除机制；</li>
</ol>
<h4 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h4><ol>
<li>客户端语言丰富，支持java、.net、php、ruby、python、go等多种语言；</li>
<li>性能卓越，单机写入TPS约在百万条/秒，消息大小10个字节；</li>
<li>提供完全分布式架构, 并有replica机制, 拥有较高的可用性和可靠性, 理论上支持消息无限堆积；</li>
<li>支持批量操作；</li>
<li>消费者采用Pull方式获取消息, 消息有序, 通过控制能够保证所有消息被消费且仅被消费一次;</li>
<li>有优秀的第三方Kafka Web管理界面Kafka-Manager；</li>
<li>在日志领域比较成熟，被多家公司和多个开源项目使用；</li>
</ol>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><ol>
<li>Kafka单机超过64个队列/分区，Load会发生明显的飙高现象，队列越多，load越高，发送消息响应时间变长</li>
<li>使用短轮询方式，实时性取决于轮询间隔时间；</li>
<li>消费失败不支持重试；</li>
<li>支持消息顺序，但是一台代理宕机后，就会产生消息乱序；</li>
<li>社区更新较慢；</li>
</ol>
<h3 id="ActiveMQ、RabbitMQ、RocketMQ、Kafka比较"><a href="#ActiveMQ、RabbitMQ、RocketMQ、Kafka比较" class="headerlink" title="ActiveMQ、RabbitMQ、RocketMQ、Kafka比较"></a>ActiveMQ、RabbitMQ、RocketMQ、Kafka比较</h3><table>
<thead>
<tr>
<th>特性</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>单机吞吐量</td>
<td>万级，比 RocketMQ、Kafka 低一个数量级</td>
<td>同 ActiveMQ</td>
<td>10 万级，支撑高吞吐</td>
<td>10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景</td>
</tr>
<tr>
<td>topic 数量对吞吐量的影响</td>
<td></td>
<td></td>
<td>topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic</td>
<td>topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源</td>
</tr>
<tr>
<td>时效性</td>
<td>ms 级</td>
<td>微秒级，这是 RabbitMQ 的一大特点，延迟最低</td>
<td>ms 级</td>
<td>延迟在 ms 级以内</td>
</tr>
<tr>
<td>可用性</td>
<td>高，基于主从架构实现高可用</td>
<td>同 ActiveMQ</td>
<td>非常高，分布式架构</td>
<td>非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用</td>
</tr>
<tr>
<td>消息可靠性</td>
<td>有较低的概率丢失数据</td>
<td>基本不丢</td>
<td>经过参数优化配置，可以做到 0 丢失</td>
<td>同 RocketMQ</td>
</tr>
<tr>
<td>功能支持</td>
<td>MQ 领域的功能极其完备</td>
<td>基于 erlang 开发，并发能力很强，性能极好，延时很低</td>
<td>MQ 功能较为完善，还是分布式的，扩展性好</td>
<td>功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用</td>
</tr>
</tbody></table>
<p>对于<strong>中小型公司</strong>，技术实力较为一般，技术挑战不是特别高，用 RabbitMQ 是不错的选择。</p>
<p>对于<strong>大型公司</strong>，基础架构研发实力较强，用 RocketMQ 是很好的选择。</p>
<p>如果是<strong>大数据领域</strong>的实时计算、日志采集等场景，用 Kafka 是业内标准的，绝对没问题，社区活跃度很高，绝对不会黄，何况几乎是全世界这个领域的事实性规范。</p>
<blockquote>
<p>参考资料：</p>
<p>中华石杉–互联网Java进阶面试训练营：<a href="https://github.com/cyh756085049/Java-Interview-Advanced" target="_blank" rel="noopener">https://github.com/cyh756085049/Java-Interview-Advanced</a></p>
<p>分布式消息队列：<a href="https://github.com/cyh756085049/Java-Interview-Advanced" target="_blank" rel="noopener">https://github.com/cyh756085049/Java-Interview-Advanced</a></p>
<p>什么是消息队列？：<a href="https://juejin.im/post/5cb025fb5188251b0351ef48" target="_blank" rel="noopener">https://juejin.im/post/5cb025fb5188251b0351ef48</a></p>
<p>消息队列技术介绍：<a href="https://www.jianshu.com/p/689ce4205021" target="_blank" rel="noopener">https://www.jianshu.com/p/689ce4205021</a></p>
<p>消息队列及常见消息队列介绍：<a href="https://cloud.tencent.com/developer/article/1006035" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1006035</a></p>
<p>通俗易懂，正确理解并用好MQ消息队列：<a href="https://cloud.tencent.com/developer/article/1346912" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1346912</a></p>
<p>消息队列之 ActiveMQ：<a href="https://juejin.im/post/5ad46f34518825651d08265c" target="_blank" rel="noopener">https://juejin.im/post/5ad46f34518825651d08265c</a></p>
<p>消息队列两种模式：<a href="https://cloud.tencent.com/developer/article/1116301" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1116301</a></p>
</blockquote>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MQ/">
                                    <span class="chip bg-color">MQ</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '69981b3a8d9bb8970c58',
        clientSecret: '2dced5add1e38f1190f6537ae3fc262808dbb905',
        repo: 'gitalk',
        owner: 'cyh756085049',
        admin: "cyh756085049",
        id: '2020-04-25T18-17-14',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'dkHeciAxwC6Al978y1RSxiqq-gzGzoHsz',
        appKey: 'W1ENUD4DHJ1IfDpTEQ8JeBFW',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/05/a-li-yun-fu-wu-qi-gou-mai-ji-da-jian-pei-zhi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="阿里云服务器购买及搭建配置">
                        
                        <span class="card-title">阿里云服务器购买及搭建配置</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            阿里云服务器搭建及软件安装配置
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-05-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%B7%A5%E5%85%B7/" class="post-category">
                                    工具
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/">
                        <span class="chip bg-color">阿里云服务器</span>
                    </a>
                    
                    <a href="/tags/Ubuntu/">
                        <span class="chip bg-color">Ubuntu</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/04/24/shi-yong-gong-ju-ji-lu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="使用工具记录">
                        
                        <span class="card-title">使用工具记录</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            使用工具记录
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-04-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%B7%A5%E5%85%B7/" class="post-category">
                                    工具
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%B7%A5%E5%85%B7/">
                        <span class="chip bg-color">工具</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://cyh756085049.github.io" target="_blank">cyh</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank"> hexo-theme-matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">174.7k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/cyh756085049" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:756085049@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=756085049" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 756085049" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title = "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) }) </script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/ppfzpxwqiaxotmryofkmshcnaz4vmxsv.js"></script>
        <script> 
            $(document).ready(function () {
                setInterval(change_Tidio, 50);  
                function change_Tidio() { 
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";   
                        document.getElementById("tidio-chat-iframe").style.right="-15px";   
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    } 
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;   
                        document.getElementById("tidio-chat-iframe").style.right="-15px"; 
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;   
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                } 
            }); 
        </script>
    

    

    

    

    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
